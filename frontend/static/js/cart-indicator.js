(() => {
  const DEV_ACCESS_FLAG_KEY = 'developerAccessGranted';

  const clearPersistedAccess = () => {
    try {
      window.localStorage?.removeItem(DEV_ACCESS_FLAG_KEY);
    } catch {
      /* noop */
    }
  };

  const hasDeveloperAccess = () => {
    try {
      return window.sessionStorage?.getItem(DEV_ACCESS_FLAG_KEY) === 'true';
    } catch {
      return false;
    }
  };

  const grantDeveloperAccess = () => {
    try {
      window.sessionStorage?.setItem(DEV_ACCESS_FLAG_KEY, 'true');
    } catch {
      /* noop */
    }
  };

  const showDeveloperGate = () => {
    if (hasDeveloperAccess()) return;
    if (document.getElementById('developer-access-gate')) return;

    const originalOverflow = document.body.style.overflow;
    document.body.style.overflow = 'hidden';

    const overlay = document.createElement('div');
    overlay.id = 'developer-access-gate';
    overlay.setAttribute('role', 'dialog');
    overlay.setAttribute('aria-modal', 'true');
    overlay.style.cssText = [
      'position:fixed',
      'inset:0',
      'z-index:100000',
      'background:rgba(10,16,22,0.9)',
      'backdrop-filter:blur(6px)',
      'display:flex',
      'align-items:center',
      'justify-content:center',
      'padding:24px',
    ].join(';');

    const panel = document.createElement('div');
    panel.style.cssText = [
      'width:100%',
      'max-width:420px',
      'background:#ffffff',
      'border-radius:16px',
      'box-shadow:0 20px 50px rgba(0,0,0,0.25)',
      'border:1px solid rgba(15,23,42,0.08)',
      'overflow:hidden',
      'font-family: "Plus Jakarta Sans", "Noto Sans", system-ui, -apple-system, sans-serif',
    ].join(';');

    panel.innerHTML = `
      <div style="height:4px; background:linear-gradient(90deg, #13a4ec, #2563eb);"></div>
      <div style="padding:24px; display:flex; flex-direction:column; gap:14px;">
        <div style="display:flex; align-items:center; gap:12px; justify-content:space-between;">
          <div>
            <p style="margin:0; text-transform:uppercase; letter-spacing:0.2em; font-size:11px; font-weight:700; color:#6b7280;">Developer Access</p>
            <h2 style="margin:4px 0 0; font-size:22px; font-weight:800; color:#0f172a; letter-spacing:-0.01em;">Enter 6-digit code</h2>
          </div>
          <div style="display:flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:12px; background:#e0f2fe; color:#0f172a; font-weight:800;">ðŸ”’</div>
        </div>
        <p style="margin:0; color:#334155; font-size:14px; line-height:1.5;">This preview is locked. Enter the developer code to access the page.</p>
        <form data-developer-gate-form style="display:flex; flex-direction:column; gap:12px;">
          <div style="display:flex; gap:12px; align-items:center;">
            <input
              data-developer-gate-input
              type="text"
              inputmode="numeric"
              pattern="\\d{6}"
              maxlength="7"
              autocomplete="one-time-code"
              placeholder="0000000"
              aria-label="6 digit developer code"
              required
              style="flex:1; padding:12px 14px; border-radius:10px; border:1px solid #cbd5e1; font-size:16px; letter-spacing:0.2em; text-align:center; font-weight:700; color:#0f172a; outline:none;"
            />
            <button type="submit" style="padding:12px 18px; border:none; background:#13a4ec; color:#ffffff; border-radius:10px; font-weight:800; font-size:14px; letter-spacing:0.05em; cursor:pointer; box-shadow:0 10px 20px rgba(19,164,236,0.25);">Unlock</button>
          </div>
          <p data-developer-gate-error style="margin:0; color:#dc2626; font-size:13px; display:none;">Enter the 6-digit code to continue.</p>
          <p style="margin:0; color:#64748b; font-size:12px; text-transform:uppercase; letter-spacing:0.12em;">
            Enter the Secret Code generated by admin Â· contact admin for code:
            <a href="https://mail.google.com/mail/?view=cm&fs=1&to=owner.seira@gmail.com" target="_blank" rel="noopener noreferrer" style="color:#0ea5e9; text-decoration:underline; text-transform:none; letter-spacing:normal;">owner.seira@gmail.com</a>
          </p>
        </form>
      </div>
    `;

    const form = panel.querySelector('[data-developer-gate-form]');
    const input = panel.querySelector('[data-developer-gate-input]');
    const error = panel.querySelector('[data-developer-gate-error]');

    const showError = (message) => {
      if (!error) return;
      error.textContent = message;
      error.style.display = 'block';
      if (input) {
        input.setAttribute('aria-invalid', 'true');
        input.focus();
        input.select?.();
      }
    };

    form?.addEventListener('submit', (event) => {
      event.preventDefault();
      const value = input?.value?.trim() || '';
      if (!/^\d{6}$/.test(value)) {
        showError('Please enter a 6-digit code (0-9).');
        return;
      }
      grantDeveloperAccess();
      document.body.style.overflow = originalOverflow;
      overlay.remove();
    });

    overlay.appendChild(panel);
    document.body.appendChild(overlay);
    input?.focus();
  };

  const enforceDeveloperGate = () => {
    clearPersistedAccess();
    if (hasDeveloperAccess()) return;
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', showDeveloperGate, { once: true });
    } else {
      showDeveloperGate();
    }
  };

  enforceDeveloperGate();

  const CART_COUNT_KEY = 'cartCount';
  const CART_ITEMS_KEY = 'cartItems';

  const parsePriceValue = (value) => {
    if (typeof value === 'number' && Number.isFinite(value)) return value;
    if (!value) return 0;
    const match = String(value).replace(/[^0-9.]/g, '');
    const parsed = parseFloat(match);
    return Number.isFinite(parsed) ? parsed : 0;
  };

  const normalizeItem = (item = {}) => {
    const quantity = Number(item.quantity) > 0 ? Math.floor(Number(item.quantity)) : 1;
    const id = item.id || `item-${Date.now()}`;
    const size = item.size || item.selectedSize || '';
    const variant = item.variant || (size ? `size-${size}` : '');
    const key = item.key || [id, variant].filter(Boolean).join('__') || id;
    return {
      id,
      key,
      variant,
      size,
      title: item.title || 'Seira Exclusive',
      priceText: item.priceText || item.price || '$0.00',
      priceValue: parsePriceValue(item.priceValue ?? item.price),
      description: item.description || '',
      image: item.image || '',
      gallery: Array.isArray(item.gallery) ? item.gallery : [],
      quantity,
    };
  };

  const readItems = () => {
    try {
      const raw = window.localStorage?.getItem(CART_ITEMS_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return [];
      return parsed.map(normalizeItem);
    } catch {
      return [];
    }
  };

  const writeItems = (items) => {
    try {
      window.localStorage?.setItem(CART_ITEMS_KEY, JSON.stringify(items));
    } catch (error) {
      console.warn('Unable to persist cart items', error);
    }
    syncCount(items);
    return items;
  };

  const getItems = () => readItems();

  const getCountFromItems = (items) =>
    (items || []).reduce((sum, item) => sum + (Number(item.quantity) > 0 ? Number(item.quantity) : 0), 0);

  const renderCount = (count) => {
    document.querySelectorAll('[data-cart-count]').forEach((badge) => {
      badge.textContent = String(count);
    });
  };

  const syncCount = (items) => {
    const count = getCountFromItems(items);
    try {
      window.localStorage?.setItem(CART_COUNT_KEY, String(count));
    } catch (error) {
      console.warn('Unable to persist cart count', error);
    }
    renderCount(count);
    return count;
  };

  const refresh = () => {
    const items = readItems();
    if (items.length) {
      syncCount(items);
      return;
    }
    // Fallback to legacy count
    const legacyCount = Number(window.localStorage?.getItem(CART_COUNT_KEY));
    renderCount(Number.isFinite(legacyCount) ? legacyCount : 0);
  };

  const setCount = (value) => {
    const count = Number(value);
    if (!Number.isFinite(count)) return;
    try {
      window.localStorage?.setItem(CART_COUNT_KEY, String(count));
    } catch (error) {
      console.warn('Unable to persist cart count', error);
    }
    renderCount(count);
  };

  const removeItem = (key) => {
    if (!key) return;
    const nextItems = readItems().filter((item) => item.key !== key);
    writeItems(nextItems);
  };

  const updateItemQuantity = (key, quantity) => {
    if (!key) return;
    const items = readItems();
    const target = items.find((item) => item.key === key);
    if (!target) return;
    const nextQuantity = Math.floor(Number(quantity));
    if (!Number.isFinite(nextQuantity) || nextQuantity <= 0) {
      removeItem(key);
      return;
    }
    target.quantity = nextQuantity;
    writeItems(items);
  };

  const addItem = (item = {}) => {
    const items = readItems();
    const normalized = normalizeItem(item);
    const existing = items.find((entry) => entry.key === normalized.key);
    if (existing) {
      existing.quantity += normalized.quantity;
    } else {
      items.push(normalized);
    }
    writeItems(items);
    return items;
  };

  const clearItems = () => {
    writeItems([]);
  };

  window.SeiraCartIndicator = {
    setCount,
    refresh,
    getItems,
    addItem,
    removeItem,
    updateItemQuantity,
    clearItems,
    parsePriceValue,
  };

  refresh();
})();
